name: API Deploy

on:
  workflow_dispatch:  # Manual trigger
  workflow_run:
    workflows: ["API CI/CD"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    # Only run if the CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      id-token: write   # Required for OIDC authentication
      contents: read    # Required for checkout

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.0.0
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::646385694251:role/recycling-buddy-deployment
          aws-region: ap-southeast-2

      - name: Get infrastructure outputs from Terraform
        id: terraform
        working-directory: infra
        run: |
          terraform init
          ECR_URL=$(terraform output -raw ecr_repository_url)
          CLUSTER_NAME=$(terraform output -raw ecs_cluster_name)
          SERVICE_NAME=$(terraform output -raw ecs_service_name)
          API_URL=$(terraform output -raw api_url)
          echo "ecr_url=$ECR_URL" >> $GITHUB_OUTPUT
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Determine image tag
        id: image
        env:
          ECR_URL: ${{ steps.terraform.outputs.ecr_url }}
        run: |
          # Use the SHA from the workflow_run event, or current SHA for manual triggers
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            IMAGE_TAG="${{ github.event.workflow_run.head_sha }}"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi
          IMAGE_URI="$ECR_URL:$IMAGE_TAG"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "Deploying image: $IMAGE_URI"

      - name: Deploy to ECS
        env:
          CLUSTER_NAME: ${{ steps.terraform.outputs.cluster_name }}
          SERVICE_NAME: ${{ steps.terraform.outputs.service_name }}
        run: |
          echo "Deploying to ECS cluster $CLUSTER_NAME, service $SERVICE_NAME"

          # Force new deployment to pull latest :latest image
          aws ecs update-service \
            --cluster "$CLUSTER_NAME" \
            --service "$SERVICE_NAME" \
            --force-new-deployment \
            --no-cli-pager

          echo "‚úÖ Deployment initiated"

      - name: Wait for deployment
        env:
          CLUSTER_NAME: ${{ steps.terraform.outputs.cluster_name }}
          SERVICE_NAME: ${{ steps.terraform.outputs.service_name }}
        run: |
          echo "‚è≥ Waiting for ECS deployment to stabilize..."

          # Wait for service to reach steady state (max 10 minutes)
          aws ecs wait services-stable \
            --cluster "$CLUSTER_NAME" \
            --services "$SERVICE_NAME"

          echo "‚úÖ Deployment successful! Service is stable."

      - name: Display deployment info
        if: success()
        env:
          API_URL: ${{ steps.terraform.outputs.api_url }}
        run: |
          echo "üöÄ API deployed successfully!"
          echo "üìç Service URL: $API_URL"
          echo "üè• Health check: $API_URL/health"
