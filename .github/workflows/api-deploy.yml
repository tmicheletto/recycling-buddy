name: API Deploy

on:
  workflow_dispatch:  # Manual trigger
  workflow_run:
    workflows: ["API CI/CD"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    name: Deploy to App Runner
    runs-on: ubuntu-latest
    # Only run if the CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.0.0
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2

      - name: Get infrastructure outputs from Terraform
        id: terraform
        working-directory: infra
        run: |
          terraform init
          ECR_URL=$(terraform output -raw ecr_repository_url)
          SERVICE_ARN=$(terraform output -raw apprunner_service_arn)
          echo "ecr_url=$ECR_URL" >> $GITHUB_OUTPUT
          echo "service_arn=$SERVICE_ARN" >> $GITHUB_OUTPUT

      - name: Determine image tag
        id: image
        env:
          ECR_URL: ${{ steps.terraform.outputs.ecr_url }}
        run: |
          # Use the SHA from the workflow_run event, or current SHA for manual triggers
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            IMAGE_TAG="${{ github.event.workflow_run.head_sha }}"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi
          IMAGE_URI="$ECR_URL:$IMAGE_TAG"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "Deploying image: $IMAGE_URI"

      - name: Deploy to App Runner
        env:
          SERVICE_ARN: ${{ steps.terraform.outputs.service_arn }}
          IMAGE_URI: ${{ steps.image.outputs.image_uri }}
        run: |
          echo "Deploying image $IMAGE_URI to App Runner service $SERVICE_ARN"

          # Update App Runner service with new image
          OPERATION_ID=$(aws apprunner update-service \
            --service-arn "$SERVICE_ARN" \
            --source-configuration "ImageRepository={ImageIdentifier=$IMAGE_URI,ImageRepositoryType=ECR,ImageConfiguration={Port=8000}}" \
            --query 'OperationId' \
            --output text)

          echo "Deployment initiated with operation ID: $OPERATION_ID"
          echo "operation_id=$OPERATION_ID" >> $GITHUB_OUTPUT

      - name: Wait for deployment
        env:
          SERVICE_ARN: ${{ steps.terraform.outputs.service_arn }}
        run: |
          echo "Waiting for App Runner deployment to complete..."

          # Poll service status until deployment is complete
          MAX_ATTEMPTS=60  # 10 minutes max (60 * 10 seconds)
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws apprunner describe-service \
              --service-arn "$SERVICE_ARN" \
              --query 'Service.Status' \
              --output text)

            echo "Current status: $STATUS (attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS)"

            if [ "$STATUS" = "RUNNING" ]; then
              echo "‚úÖ Deployment successful! Service is running."
              exit 0
            elif [ "$STATUS" = "OPERATION_IN_PROGRESS" ] || [ "$STATUS" = "CREATING" ]; then
              echo "‚è≥ Deployment in progress..."
              sleep 10
              ATTEMPT=$((ATTEMPT + 1))
            else
              echo "‚ùå Unexpected status: $STATUS"
              exit 1
            fi
          done

          echo "‚ùå Deployment timed out after 10 minutes"
          exit 1

      - name: Get deployment URL
        if: success()
        env:
          SERVICE_ARN: ${{ steps.terraform.outputs.service_arn }}
        run: |
          SERVICE_URL=$(aws apprunner describe-service \
            --service-arn "$SERVICE_ARN" \
            --query 'Service.ServiceUrl' \
            --output text)

          echo "üöÄ API deployed successfully!"
          echo "üìç Service URL: https://$SERVICE_URL"
          echo "üè• Health check: https://$SERVICE_URL/health"
