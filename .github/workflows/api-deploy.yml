name: API Deploy

on:
  workflow_dispatch:  # Manual trigger
  workflow_run:
    workflows: ["API CI/CD", "Infra Deploy"]
    types: [completed]
    branches: [main]

env:
  AWS_REGION: ap-southeast-2
  ECR_REPOSITORY: 646385694251.dkr.ecr.ap-southeast-2.amazonaws.com/recycling-buddy-api
  ECS_CLUSTER: recycling-buddy
  ECS_SERVICE: recycling-buddy-api

jobs:
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    # Only run if the CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      id-token: write   # Required for OIDC authentication
      contents: read    # Required for checkout

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::646385694251:role/recycling-buddy-deployment
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine image tag
        id: image
        run: |
          # Use the SHA from the workflow_run event, or current SHA for manual triggers
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            IMAGE_TAG="${{ github.event.workflow_run.head_sha }}"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi
          IMAGE_URI="$ECR_REPOSITORY:$IMAGE_TAG"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "Deploying image: $IMAGE_URI"

      - name: Deploy to ECS
        run: |
          echo "Deploying to ECS cluster $ECS_CLUSTER, service $ECS_SERVICE"

          # Force new deployment to pull latest :latest image
          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --force-new-deployment \
            --no-cli-pager

          echo "‚úÖ Deployment initiated"

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for ECS deployment to stabilize..."

          # Wait for service to reach steady state (max 10 minutes)
          aws ecs wait services-stable \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE"

          echo "‚úÖ Deployment successful! Service is stable."

      - name: Display deployment info
        if: success()
        run: |
          echo "üöÄ API deployed successfully!"
          echo "üìç Cluster: $ECS_CLUSTER"
          echo "üìç Service: $ECS_SERVICE"
